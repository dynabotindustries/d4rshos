<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D4rsh OS</title>
    <style>
        :root {
            --bg-color: #f1f3f4;
            --taskbar-color: rgba(32, 33, 36, 0.9);
            --window-bg: #ffffff;
            --text-color: #202124;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            height: 100vh;
            width: 100vw;
            color: #202124;
            -webkit-font-smoothing: antialiased;
        }

        /* Desktop Area */
        #desktop {
            height: calc(100vh - 40px);
            width: 100%;
            position: relative;
            overflow: hidden;
            padding-right: 260px;
        }

        /* Icons on Desktop */
        .desktop-icon {
            width: 80px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
            float: left;
            text-align: center;
            font-size: 12px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .desktop-icon:hover { background: rgba(255,255,255,0.2); border-radius: 12px; }
        .desktop-icon span { font-size: 24px; margin-bottom: 5px; }

        /* Window Styles */
        .window {
            position: absolute;
            background: var(--window-bg);
            border: none;
            border-radius: 12px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
            resize: both; /* Native CSS Resizing */
            overflow: hidden;
            padding: 0;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            resize: none;
            border-radius: 0;
            padding: 0;
        }

        .title-bar {
            height: 36px;
            background: #f1f3f4;
            border-bottom: 1px solid #dadce0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            cursor: grab;
            color: #5f6368;
            font-size: 13px;
        }

        .title-bar:active { cursor: grabbing; }

        .window-controls button {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .window-controls button:hover { background: rgba(0,0,0,0.1); }
        .window-controls button:last-child:hover { background: #e81123; color: white; }

        .window-content {
            flex: 1;
            padding: 10px;
            overflow: auto;
            background: #fff;
            color: #202124;
            position: relative;
            cursor: auto;
        }

        /* Taskbar */
        #taskbar {
            height: 48px;
            background: var(--taskbar-color);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-top: none;
            box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
            z-index: 9999;
            position: absolute;
            bottom: 0;
            width: 100%;
            justify-content: flex-end;
        }

        #start-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            box-shadow: none;
            margin-right: 10px;
            cursor: pointer;
            font-size: 0;
            position: relative;
            overflow: hidden;
            transition: background 0.2s;
        }
        #start-btn::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 14px; height: 14px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
        }
        #start-btn:hover { background: rgba(255,255,255,0.2); }

        #taskbar-apps {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        #clock {
            color: #e8eaed;
            font-weight: 500;
        }

        #system-tray {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 6px 16px;
            border-radius: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #system-tray:hover { background: rgba(255,255,255,0.2); }

        /* Quick Settings */
        #quick-settings {
            position: absolute;
            bottom: 60px;
            right: 12px;
            width: 320px;
            background: rgba(32, 33, 36, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            z-index: 10000;
            color: #e8eaed;
        }

        .qs-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .qs-slider-container span {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        #quick-settings input[type=range] {
            flex: 1;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            height: 4px;
            border-radius: 2px;
            border: none;
            padding: 0;
            margin: 0;
            box-shadow: none;
        }

        #quick-settings input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #8ab4f8;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        #quick-settings input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Overlay for brightness */
        #brightness-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            opacity: 0;
            pointer-events: none;
            z-index: 99999;
            transition: opacity 0.1s;
        }

        .taskbar-item {
            padding: 0 12px;
            height: 36px;
            display: flex;
            align-items: center;
            margin: 0 4px;
            background: transparent;
            border: none;
            border-radius: 18px;
            box-shadow: none;
            cursor: pointer;
            font-size: 12px;
            min-width: auto;
            color: #e8eaed;
            text-shadow: none;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .taskbar-item:hover { 
            background: rgba(255,255,255,0.1); 
            box-shadow: none; }
        .taskbar-item.active { 
            background: rgba(255,255,255,0.15);
            border: none;
            box-shadow: none;
        }

        /* App Specific Styles */
        input, textarea {
            width: 100%;
            background: #fff;
            color: #000;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            padding: 5px;
            margin-bottom: 5px;
        }

        button.app-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            margin-top: 5px;
            border-radius: 4px;
            font-weight: 500;
        }
        button.app-btn:hover { background: #1765cc; }

        ul { list-style: none; padding: 0; }
        #todo-list li { background: #fff; border: 1px solid #ddd; color: #000; padding: 5px; margin-bottom: 2px; display: flex; justify-content: space-between; }
        
        /* File Explorer */
        .file-explorer-container { display: flex; height: 100%; gap: 10px; }
        .file-list-panel { width: 150px; border-right: 1px solid #ccc; padding-right: 10px; display: flex; flex-direction: column; }
        .file-list-panel ul { flex: 1; overflow-y: auto; }
        .file-list-panel li { cursor: pointer; padding: 5px; border-radius: 3px; margin-bottom: 2px; color: #000; }
        .file-list-panel li:hover { background: #e0e0e0; border: 1px solid #ccc; }
        .file-preview-panel { flex: 1; display: flex; flex-direction: column; }
        .file-preview-panel textarea { flex: 1; resize: none; background: #fff; color: #000; user-select: text; }
        #preview-content { color: #333 !important; }

        /* Calculator */
        .calculator-container { height: 100%; display: flex; flex-direction: column; }
        #calc-display { text-align: right; font-size: 1.5em; padding: 10px; margin-bottom: 10px; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; flex: 1; }
        .calc-btn { background: linear-gradient(to bottom, #f9f9f9 0%, #e0e0e0 100%); border: 1px solid #999; color: black; font-size: 1.2em; cursor: pointer; border-radius: 4px; }
        .calc-btn:hover { background: linear-gradient(to bottom, #fff 0%, #f0f0f0 100%); border-color: #3c7fb1; box-shadow: 0 0 2px rgba(60,127,177,0.5); }
        .calc-btn.op { background: linear-gradient(to bottom, #e6e6e6 0%, #d0d0d0 100%); }
        .calc-btn.clear { background: #ffcccc; }
        .calc-btn.equals { background: #1f8ad6; grid-column: 4; grid-row: 4 / span 2; }
        .calc-btn.plus { grid-row: 2 / span 2; }
        .calc-btn.zero { grid-column: 1 / span 2; }

        /* Paint App */
        .paint-toolbar { display: flex; align-items: center; gap: 10px; padding-bottom: 5px; border-bottom: 1px solid #ccc; margin-bottom: 5px; }
        .paint-toolbar input[type="color"] { width: 30px; height: 30px; padding: 0; border: none; background: none; }
        .paint-palette { display: flex; gap: 2px; }
        .paint-color-swatch { width: 20px; height: 20px; border: 1px solid #555; cursor: pointer; }

        /* Camera & Video */
        .media-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: #000; }
        .media-container video { width: 100%; flex: 1; object-fit: contain; }
        .camera-controls { padding: 10px; display: flex; justify-content: center; background: #222; }

        /* Markdown Editor */
        .markdown-container { display: flex; height: 100%; gap: 10px; }
        .markdown-container textarea { flex: 1; resize: none; background: #fff; color: #000; border: 1px solid #ccc; padding: 10px; font-family: monospace; }
        .markdown-container #md-preview { flex: 1; overflow-y: auto; padding: 10px; background: #fff; color: #000; border: 1px solid #ccc; word-wrap: break-word; }
        .markdown-container #md-preview img { max-width: 100%; }

        /* Music Player */
        .music-visualizer { width: 100%; flex: 1; background: #000; }

        /* Clock App */
        .clock-container { text-align: center; display: flex; flex-direction: column; height: 100%; justify-content: center; }
        .clock-time { font-size: 2.5em; margin-bottom: 10px; font-family: monospace; }
        .clock-tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }

        /* PDF Viewer */
        .pdf-container { display: flex; flex-direction: column; height: 100%; }
        .pdf-container iframe { flex: 1; border: none; background: white; }

        /* Image Viewer */
        .image-viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .image-viewer-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Weather Widget */
        #weather-widget {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 220px;
            background: rgba(22, 33, 62, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            color: white;
            z-index: 1;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            user-select: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        #weather-widget:hover { transform: scale(1.02); background: rgba(22, 33, 62, 0.8); }
        .weather-main { display: flex; align-items: center; justify-content: space-between; }
        .weather-temp { font-size: 36px; font-weight: 300; }
        .weather-icon { font-size: 32px; }
        .weather-details { text-align: right; }
        .weather-desc { font-size: 14px; color: #ddd; text-transform: capitalize; }
        .weather-loc { font-size: 12px; color: #aaa; margin-top: 8px; display: flex; align-items: center; gap: 5px; }

        /* Calendar App */
        .calendar-container { height: 100%; display: flex; flex-direction: column; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #e0e0e0; border-bottom: 1px solid #ccc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; flex: 1; text-align: center; align-content: start; }
        .calendar-day-name { font-weight: bold; padding: 5px; background: #f0f0f0; font-size: 0.9em; color: #333; }
        .calendar-date { padding: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #000; }
        .calendar-date:hover { background: #d0e0f0; border: 1px solid #a0c0e0; }
        .calendar-date.today { background: #e0f0ff; border: 1px solid #80b0e0; font-weight: bold; }
        .calendar-date.empty { background: transparent; cursor: default; }

        /* Browser App */
        .browser-container { display: flex; flex-direction: column; height: 100%; }
        .browser-toolbar { display: flex; gap: 5px; padding: 5px; background: #e0e0e0; border-bottom: 1px solid #ccc; align-items: center; }
        .browser-bookmarks { display: flex; gap: 5px; padding: 5px; background: #f0f0f0; border-bottom: 1px solid #ccc; }
        .browser-address { flex: 1; padding: 5px; border-radius: 15px; border: 1px solid #ccc; padding-left: 10px; }
        .browser-frame { flex: 1; width: 100%; border: none; background: white; }

        /* Maps App */
        .maps-container { display: flex; flex-direction: column; height: 100%; }
        .maps-frame { flex: 1; border: none; width: 100%; height: 100%; }

        /* Terminal App */
        .terminal-container { background: #1e1e1e; color: #0f0; font-family: 'Courier New', monospace; height: 100%; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .terminal-output { flex: 1; overflow-y: auto; white-space: pre-wrap; font-size: 14px; }
        .terminal-input-line { display: flex; align-items: center; }
        .terminal-prompt { margin-right: 8px; color: #0f0; font-weight: bold; }
        .terminal-input { background: transparent !important; border: none !important; color: #0f0 !important; flex: 1; outline: none; font-family: 'Courier New', monospace; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }

        /* Matrix Text Effect */
        .matrix-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            cursor: pointer;
            letter-spacing: 1px;
            display: inline-block;
        }

        canvas { background: #000; display: block; margin: 0 auto; border: 1px solid #444; }

        /* Helper for text selection in inputs */
        .window-content input, .window-content textarea { user-select: text; }

        /* Start Menu */
        #start-menu {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 640px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 24px;
            display: none;
            flex-direction: column;
            z-index: 10000;
            padding: 24px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        #start-search {
            width: 100%;
            padding: 12px 20px;
            border-radius: 24px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            font-size: 16px;
            color: #202124;
            margin-bottom: 20px;
            outline: none;
        }

        #start-apps-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            overflow-y: auto;
        }

        .start-menu-item {
            padding: 16px;
            cursor: pointer;
            color: #202124;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 16px;
            border: 1px solid transparent;
        }
        .start-menu-item:hover { 
            background: rgba(0,0,0,0.05);
            border-color: transparent;
            box-shadow: none;
        }
        .start-menu-item span { margin-right: 0; margin-bottom: 8px; font-size: 32px; }

        /* Content Resizing Helpers */
        .game-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .game-container canvas { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: pixelated; }
        .diary-container { display: flex; flex-direction: column; height: 100%; }
        .diary-container textarea { flex: 1; resize: none; }

        /* Settings App */
        .settings-container { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .settings-group { background: #fff; border: 1px solid #dadce0; padding: 15px; border-radius: 8px; color: #202124; }
    </style>
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</head>
<body>

    <div id="brightness-overlay"></div>

    <div id="desktop">
        <!-- Icons generated by JS -->
    </div>

    <div id="quick-settings">
        <div class="qs-slider-container">
            <span>üîÜ</span>
            <input type="range" min="20" max="100" value="100" oninput="setBrightness(this.value)">
        </div>
        <div class="qs-slider-container">
            <span>üîä</span>
            <input type="range" min="0" max="100" value="100">
        </div>
    </div>

    <div id="start-menu">
        <!-- Items generated by JS -->
    </div>

    <div id="taskbar">
        <div id="taskbar-apps">
            <button id="start-btn" onclick="toggleStartMenu()" title="Launcher"></button>
        </div>
        <div id="system-tray" onclick="toggleQuickSettings()">
            <div id="clock">00:00</div>
        </div>
    </div>

    <script>
        // --- OS STATE ---
        let zIndexCounter = 100;
        const apps = [
            { id: 'todo', name: 'To-Do List', icon: 'üìù', type: 'app' },
            { id: 'diary', name: 'Daily Diary', icon: 'üìî', type: 'app' },
            { id: 'log', name: 'Hourly Log', icon: '‚è±Ô∏è', type: 'app' },
            { id: 'files', name: 'File Explorer', icon: 'üìÅ', type: 'app' },
            { id: 'browser', name: 'Browser', icon: 'üåê', type: 'app' },
            { id: 'maps', name: 'Maps', icon: 'üó∫Ô∏è', type: 'app' },
            { id: 'terminal', name: 'Terminal', icon: 'üíª', type: 'app' },
            { id: 'calculator', name: 'Calculator', icon: 'üßÆ', type: 'app' },
            { id: 'settings', name: 'Settings', icon: '‚öôÔ∏è', type: 'app' },
            { id: 'notes', name: 'Notes', icon: 'üóíÔ∏è', type: 'app' },
            { id: 'imageviewer', name: 'Image Viewer', icon: 'üñºÔ∏è', type: 'app' },
            { id: 'paint', name: 'Paint', icon: 'üé®', type: 'app' },
            { id: 'sysinfo', name: 'System Info', icon: '‚ÑπÔ∏è', type: 'app' },
            { id: 'camera', name: 'Camera', icon: 'üì∑', type: 'app' },
            { id: 'video', name: 'Video Player', icon: 'üé•', type: 'app' },
            { id: 'markdown', name: 'Markdown', icon: 'üìù', type: 'app' },
            { id: 'music', name: 'Music Player', icon: 'üéµ', type: 'app' },
            { id: 'clock', name: 'Clock', icon: '‚è∞', type: 'app' },
            { id: 'calendar', name: 'Calendar', icon: 'üìÖ', type: 'app' },
            { id: 'pdf', name: 'PDF Viewer', icon: 'üìÑ', type: 'app' },
            { id: 'snake', name: 'Snake', icon: 'üêç', type: 'game' },
            { id: 'dino', name: 'Chrome Dino', icon: 'ü¶ñ', type: 'game' },
            { id: 'flappy', name: 'Flappy Bird', icon: 'üê¶', type: 'game' }
        ];

        // --- INITIALIZATION ---
        function init() {
            const desktop = document.getElementById('desktop');
            const startMenu = document.getElementById('start-menu');
            const quickSettings = document.getElementById('quick-settings');

            // Setup Start Menu Structure
            startMenu.innerHTML = `
                <input type="text" id="start-search" placeholder="Search apps...">
                <div id="start-apps-grid"></div>
            `;
            const searchInput = document.getElementById('start-search');
            const appsGrid = document.getElementById('start-apps-grid');

            // Search Functionality
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.start-menu-item').forEach(item => {
                    const name = item.querySelector('div').innerText.toLowerCase();
                    item.style.display = name.includes(term) ? 'flex' : 'none';
                });
            });
            
            apps.forEach(app => {
                const icon = document.createElement('div');
                icon.className = 'desktop-icon';
                icon.innerHTML = `<span>${app.icon}</span>${app.name}`;
                icon.onclick = () => openWindow(app);
                desktop.appendChild(icon);

                // Start Menu Item
                const item = document.createElement('div');
                item.className = 'start-menu-item';
                item.innerHTML = `<span>${app.icon}</span> <div>${app.name}</div>`;
                item.onclick = () => {
                    openWindow(app);
                    toggleStartMenu();
                };
                appsGrid.appendChild(item);
            });

            setInterval(updateClock, 1000);
            updateClock();

            // Close start menu when clicking desktop
            desktop.addEventListener('mousedown', () => {
                startMenu.style.display = 'none';
                quickSettings.style.display = 'none';
            });
            loadPreferences();
            loadWeatherWidget();
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            if(menu.style.display === 'flex') document.getElementById('start-search').focus();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // --- PERSONALIZATION ---
        function loadPreferences() {
            const theme = localStorage.getItem('d4sh-theme') || 'dark';
            applyTheme(theme);
            
            const wallpaper = localStorage.getItem('d4sh-wallpaper');
            if (wallpaper) document.body.style.background = wallpaper.startsWith('http') || wallpaper.startsWith('data') ? `url(${wallpaper}) no-repeat center center / cover` : wallpaper;
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'light') {
                root.style.setProperty('--bg-color', '#f0f2f5');
                root.style.setProperty('--taskbar-color', 'rgba(255, 255, 255, 0.9)');
                root.style.setProperty('--window-bg', '#ffffff');
                root.style.setProperty('--text-color', '#007bff');
                root.style.setProperty('--white', '#1c1e21');
                root.style.setProperty('--glass', 'rgba(255, 255, 255, 0.9)');
            } else {
                root.style.setProperty('--bg-color', '#f1f3f4');
                root.style.setProperty('--taskbar-color', 'rgba(32, 33, 36, 0.9)');
                root.style.setProperty('--window-bg', '#ffffff');
                root.style.setProperty('--text-color', '#202124');
                root.style.setProperty('--white', '#ffffff');
                root.style.setProperty('--glass', 'rgba(255, 255, 255, 0.9)');
            }
            localStorage.setItem('d4sh-theme', theme);
        }

        // --- WEATHER WIDGET ---
        function loadWeatherWidget() {
            const desktop = document.getElementById('desktop');
            const widget = document.createElement('div');
            widget.id = 'weather-widget';
            widget.innerHTML = '<div style="text-align:center; font-size:12px; color:#aaa;">Loading Weather...</div>';
            desktop.appendChild(widget);

            const updateWidget = (temp, code, city) => {
                const weatherCodes = {
                    0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                    45: 'Fog', 48: 'Depositing rime fog',
                    51: 'Drizzle: Light', 53: 'Drizzle: Moderate', 55: 'Drizzle: Dense',
                    61: 'Rain: Slight', 63: 'Rain: Moderate', 65: 'Rain: Heavy',
                    71: 'Snow: Slight', 73: 'Snow: Moderate', 75: 'Snow: Heavy',
                    95: 'Thunderstorm: Slight or moderate', 99: 'Thunderstorm with slight and heavy hail'
                };
                const desc = weatherCodes[code] || 'Unknown';
                const icon = getIcon(code);

                widget.innerHTML = `
                    <div class="weather-main">
                        <div class="weather-icon">${icon}</div>
                        <div class="weather-details">
                            <div class="weather-temp">${Math.round(temp)}¬∞C</div>
                            <div class="weather-desc">${desc}</div>
                        </div>
                    </div>
                    <div class="weather-loc">üìç ${city}</div>
                `;
            };

            const getIcon = (code) => {
                if(code === 0) return '‚òÄÔ∏è';
                if(code >= 1 && code <= 3) return '‚õÖ';
                if(code >= 45 && code <= 48) return 'üå´Ô∏è';
                if(code >= 51 && code <= 67) return 'üåßÔ∏è';
                if(code >= 71 && code <= 77) return '‚ùÑÔ∏è';
                if(code >= 95) return '‚ö°';
                return 'üå°Ô∏è';
            };

            const fetchWeather = async (lat, lon, city) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const data = await res.json();
                    updateWidget(data.current_weather.temperature, data.current_weather.weathercode, city);
                } catch (e) { widget.innerHTML = '<div style="text-align:center; color:#e94560;">Weather Unavailable</div>'; }
            };

            const useIpLocation = () => {
                fetch('https://get.geojs.io/v1/ip/geo.json')
                    .then(r => r.json())
                    .then(d => fetchWeather(d.latitude, d.longitude, d.city))
                    .catch(() => widget.innerHTML = '<div style="text-align:center; color:#aaa;">Location Unavailable</div>');
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async pos => {
                        const { latitude, longitude } = pos.coords;
                        try {
                            const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
                            const data = await res.json();
                            fetchWeather(latitude, longitude, data.city || data.locality || "Local Weather");
                        } catch { fetchWeather(latitude, longitude, "Local Weather"); }
                    },
                    () => useIpLocation()
                );
            } else {
                useIpLocation();
            }
        }

        // --- GLOBAL STATE & CLEANUP HELPERS ---
        const windowFileBlobs = {};


        // --- WINDOW MANAGER ---
        function openWindow(app, data = null) {
            // Check if already open
            if (document.getElementById(`win-${app.id}`)) {
                focusWindow(document.getElementById(`win-${app.id}`));
                if (data) loadAppContent(app, `content-${app.id}`, data);
                return;
            }

            const win = document.createElement('div');
            win.className = 'window';
            win.id = `win-${app.id}`;
            win.style.left = (50 + (Math.random() * 50)) + 'px';
            win.style.top = (50 + (Math.random() * 50)) + 'px';
            win.style.width = app.type === 'game' ? '420px' : '350px';
            win.style.height = app.type === 'game' ? '450px' : '400px';
            win.style.zIndex = ++zIndexCounter;

            win.innerHTML = `
                <div class="title-bar" onmousedown="startDrag(event, '${win.id}')">
                    <span>${app.icon} ${app.name}</span>
                    <div class="window-controls">
                        <button onclick="minimizeWindow('${win.id}')">_</button>
                        <button onclick="toggleMaximize('${win.id}')">‚ñ°</button>
                        <button onclick="closeWindow('${win.id}')">√ó</button>
                    </div>
                </div>
                <div class="window-content" id="content-${app.id}"></div>
            `;

            // Focus on click
            win.addEventListener('mousedown', () => focusWindow(win));

            document.getElementById('desktop').appendChild(win);
            addToTaskbar(app);
            loadAppContent(app, `content-${app.id}`, data, win);
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            if (win) {
                // Generic cleanup for app activities
                if (win.stopAppActivity) {
                    win.stopAppActivity();
                    delete win.stopAppActivity;
                }

                // Stop game loops if applicable
                const appId = id.replace('win-', '');
                if (gameIntervals[appId]) clearInterval(gameIntervals[appId]);
                
                // Stop media streams (Camera)
                if (activeStreams[appId]) {
                    activeStreams[appId].getTracks().forEach(track => track.stop());
                    delete activeStreams[appId];
                }

                // Stop Audio Contexts (Music)
                if (audioContexts[appId]) {
                    audioContexts[appId].close();
                    delete audioContexts[appId];
                }

                // Stop App Timers (Clock)
                if (appTimers[appId]) {
                    appTimers[appId].forEach(t => clearInterval(t));
                    delete appTimers[appId];
                }

                // Clean up blob URLs from opened files
                if (windowFileBlobs[id]) {
                    URL.revokeObjectURL(windowFileBlobs[id]);
                    delete windowFileBlobs[id];
                }

                win.remove();
                document.getElementById(`task-${appId}`).remove();
            }
        }

        function focusWindow(win) {
            // Stop activities (like cmatrix) in any other windows that lose focus
            document.querySelectorAll('.window').forEach(otherWin => {
                if (otherWin.id !== win.id && otherWin.stopAppActivity) {
                    otherWin.stopAppActivity();
                }
            });

            win.style.zIndex = ++zIndexCounter;
            // Highlight taskbar
            document.querySelectorAll('.taskbar-item').forEach(el => el.classList.remove('active'));
            const appId = win.id.replace('win-', '');
            const taskItem = document.getElementById(`task-${appId}`);
            if(taskItem) taskItem.classList.add('active');
        }

        function minimizeWindow(id) {
            const win = document.getElementById(id);
            if (win && win.stopAppActivity) {
                win.stopAppActivity();
            }
            win.style.display = 'none';
            document.getElementById(`task-${id.replace('win-', '')}`).classList.remove('active');
        }

        function restoreWindow(id) {
            const win = document.getElementById(`win-${id}`);
            win.style.display = 'flex';
            focusWindow(win);
        }

        function toggleMaximize(id) {
            const win = document.getElementById(id);
            win.classList.toggle('maximized');
        }

        function addToTaskbar(app) {
            const bar = document.getElementById('taskbar-apps');
            const item = document.createElement('div');
            item.className = 'taskbar-item active';
            item.id = `task-${app.id}`;
            item.innerText = `${app.icon} ${app.name}`;
            item.onclick = () => {
                const win = document.getElementById(`win-${app.id}`);
                if (win.style.display === 'none') restoreWindow(app.id);
                else focusWindow(win);
            };
            bar.appendChild(item);
        }

        // --- DRAGGING LOGIC ---
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let currentDragWin = null;

        function startDrag(e, winId) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag if clicking controls
            const win = document.getElementById(winId);
            if (win.classList.contains('maximized')) return;

            isDragging = true;
            currentDragWin = win;
            dragOffset.x = e.clientX - win.offsetLeft;
            dragOffset.y = e.clientY - win.offsetTop;
            focusWindow(win);
        }

        document.addEventListener('mousemove', (e) => {
            if (isDragging && currentDragWin) {
                e.preventDefault();
                currentDragWin.style.left = (e.clientX - dragOffset.x) + 'px';
                currentDragWin.style.top = (e.clientY - dragOffset.y) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            currentDragWin = null;
        });

        // --- APP CONTENT LOADERS ---
        const gameIntervals = {};
        const activeStreams = {};
        const audioContexts = {};
        const appTimers = {};


        function loadAppContent(app, containerId, data = null, win = null) {
            const container = document.getElementById(containerId);            
            
            if (app.id === 'todo') loadTodo(container);
            else if (app.id === 'diary') loadDiary(container);
            else if (app.id === 'log') loadLog(container);
            else if (app.id === 'files') loadFileExplorer(container);
            else if (app.id === 'browser') loadBrowser(container);
            else if (app.id === 'maps') loadMaps(container);
            else if (app.id === 'terminal') loadTerminal(container, app.id, win);
            else if (app.id === 'calculator') loadCalculator(container);
            else if (app.id === 'settings') loadSettings(container);
            else if (app.id === 'notes') loadNotes(container, data);
            else if (app.id === 'imageviewer') loadImageViewer(container, data);
            else if (app.id === 'paint') loadPaint(container, win);
            else if (app.id === 'sysinfo') loadSysInfo(container);
            else if (app.id === 'camera') loadCamera(container, app.id);
            else if (app.id === 'video') loadVideoPlayer(container, data);
            else if (app.id === 'markdown') loadMarkdown(container);
            else if (app.id === 'music') loadMusicPlayer(container, app.id, data);
            else if (app.id === 'clock') loadClock(container, app.id);
            else if (app.id === 'calendar') loadCalendar(container);
            else if (app.id === 'pdf') loadPDFViewer(container, data);
            else if (app.id === 'snake') loadSnake(container, app.id);
            else if (app.id === 'dino') loadDino(container, app.id);
            else if (app.id === 'flappy') loadFlappy(container, app.id);
        }

        // --- PRODUCTIVITY APPS ---
        
        function loadTodo(container) {
            container.innerHTML = `
                <h3>To-Do List</h3>
                <div style="display:flex">
                    <input type="text" id="todo-input" placeholder="New Task...">
                    <button class="app-btn" id="todo-add">+</button>
                </div>
                <ul id="todo-list"></ul>
            `;
            
            const render = () => {
                const tasks = JSON.parse(localStorage.getItem('d4sh-todo') || '[]');
                const list = container.querySelector('#todo-list');
                list.innerHTML = tasks.map((t, i) => `
                    <li>
                        ${t} <button onclick="removeTodo(${i})" style="background:red;border:none;color:white;cursor:pointer">x</button>
                    </li>
                `).join('');
            };

            container.querySelector('#todo-add').onclick = () => {
                const val = container.querySelector('#todo-input').value;
                if(val) {
                    const tasks = JSON.parse(localStorage.getItem('d4sh-todo') || '[]');
                    tasks.push(val);
                    localStorage.setItem('d4sh-todo', JSON.stringify(tasks));
                    container.querySelector('#todo-input').value = '';
                    render();
                }
            };

            // Global helper for inline onclick
            window.removeTodo = (index) => {
                const tasks = JSON.parse(localStorage.getItem('d4sh-todo') || '[]');
                tasks.splice(index, 1);
                localStorage.setItem('d4sh-todo', JSON.stringify(tasks));
                render();
            };
            render();
        }

        function loadDiary(container) {
            const today = new Date().toISOString().split('T')[0];
            
            container.innerHTML = `
                <div class="diary-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <h3 style="margin:0;">Diary</h3>
                        <input type="date" id="diary-date-picker" value="${today}">
                    </div>
                    <textarea id="diary-text"></textarea>
                    <button class="app-btn" id="diary-save-btn">Save Entry</button>
                </div>
            `;

            const datePicker = container.querySelector('#diary-date-picker');
            const textArea = container.querySelector('#diary-text');
            const saveBtn = container.querySelector('#diary-save-btn');

            const loadEntry = (date) => {
                const saved = localStorage.getItem(`d4sh-diary-${date}`) || '';
                textArea.value = saved;
            };

            datePicker.addEventListener('change', (e) => loadEntry(e.target.value));
            
            saveBtn.addEventListener('click', () => {
                const date = datePicker.value;
                const txt = textArea.value;
                localStorage.setItem(`d4sh-diary-${date}`, txt);
                alert(`Diary for ${date} saved!`);
            });

            // Initial load
            loadEntry(today);
        }

        function loadLog(container) {
            const today = new Date().toISOString().split('T')[0];
            container.innerHTML = `
                <h3 style="margin-top:0;">Hourly Log</h3>
                <input type="date" id="log-date-picker" value="${today}">
                <div id="log-entries" style="margin-top: 10px; overflow-y: auto; flex: 1;"></div>
            `;
            
            const datePicker = container.querySelector('#log-date-picker');
            const entriesDiv = container.querySelector('#log-entries');

            const renderLog = (date) => {
                const hours = Array.from({length: 12}, (_, i) => i + 8); // 8am to 7pm
                let html = '';
                hours.forEach(h => {
                    const time = `${h}:00`;
                    const key = `d4sh-log-${date}-${time}`;
                    const val = localStorage.getItem(key) || '';
                    html += `
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span style="width:50px; font-size:12px;">${time}</span>
                            <input type="text" value="${val}" onchange="saveLog('${date}', '${time}', this.value)">
                        </div>
                    `;
                });
                entriesDiv.innerHTML = html;
            };

            datePicker.addEventListener('change', (e) => renderLog(e.target.value));
            
            renderLog(today);

            // Make saveLog global but date-aware
            window.saveLog = (date, time, val) => {
                const key = `d4sh-log-${date}-${time}`;
                localStorage.setItem(key, val);
            };
        }

        function loadFileExplorer(container) {
            container.innerHTML = `
                <div class="file-explorer-container">
                    <div class="file-list-panel">
                        <h3>Files</h3>
                        <ul id="file-list"></ul>
                        <div style="display:flex; gap:5px;">
                            <button class="app-btn" id="new-file-btn" style="flex:1;">New Text File</button>
                            <button class="app-btn" id="upload-file-btn" style="flex:1;">Upload</button>
                            <input type="file" id="file-upload-input" style="display:none;" multiple>
                        </div>
                    </div>
                    <div class="file-preview-panel">
                        <h3 id="preview-title">Select a file</h3>
                        <div id="preview-content" style="font-size:12px; color:#ccc; overflow-y:auto; flex:1;"></div>
                        <button class="app-btn" id="delete-file-btn" style="display:none; background:red;">Delete</button>
                    </div>
                </div>
            `;

            const fileListEl = container.querySelector('#file-list');
            const newFileBtn = container.querySelector('#new-file-btn');
            const uploadBtn = container.querySelector('#upload-file-btn');
            const uploadInput = container.querySelector('#file-upload-input');
            const deleteFileBtn = container.querySelector('#delete-file-btn');
            const previewTitle = container.querySelector('#preview-title');
            const previewContent = container.querySelector('#preview-content');
            let selectedFile = null;

            const getFiles = () => JSON.parse(localStorage.getItem('d4sh-fs') || '{}');
            const saveFiles = (files) => localStorage.setItem('d4sh-fs', JSON.stringify(files));

            const getFileIcon = (type) => {
                if (!type) return 'üìÅ';
                if (type.startsWith('video')) return 'üé•';
                if (type.startsWith('audio')) return 'üéµ';
                if (type.startsWith('text')) return 'üóíÔ∏è';
                if (type.startsWith('image')) return 'üñºÔ∏è';
                if (type === 'application/pdf') return 'üìÑ';
                return 'üìÅ';
            };

            const render = () => {
                const files = getFiles();
                fileListEl.innerHTML = Object.keys(files).map(name => {
                    const file = files[name];
                    return `<li data-filename="${name}">${getFileIcon(file.type)} ${name}</li>`;
                }).join('');
                
                if (selectedFile && !files[selectedFile]) {
                    selectedFile = null;
                    previewTitle.innerText = 'Select a file';
                    previewContent.innerHTML = '';
                    deleteFileBtn.style.display = 'none';
                }
            };

            fileListEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    // Highlight selection
                    Array.from(e.target.parentElement.children).forEach(el => el.style.background = '');
                    e.target.style.background = 'rgba(255,255,255,0.1)';

                    selectedFile = e.target.dataset.filename;
                    const files = getFiles();
                    const file = files[selectedFile];
                    previewTitle.innerText = file ? selectedFile : 'Select a file';
                    
                    if (file) {
                        let previewHTML = `<strong>Type:</strong> ${file.type}<br>`;
                        if (file.size) previewHTML += `<strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>`;
                        if (file.url) previewHTML += `<br><i style="color:#aaa;">This file is available for the current session only.</i>`;
                        
                        if (file.content !== undefined) {
                            previewHTML += `<hr><pre style="white-space:pre-wrap; word-break:break-all; user-select:text;">${file.content.substring(0, 200)}...</pre>`;
                        } else {
                            previewHTML += `<hr>Double-click to open in its app.`;
                        }
                        previewContent.innerHTML = previewHTML;
                    }
                    deleteFileBtn.style.display = 'inline-block';
                }
            });

            fileListEl.addEventListener('dblclick', (e) => {
                if (e.target.tagName === 'LI') {
                    const filename = e.target.dataset.filename;
                    const files = getFiles();
                    const fileData = files[filename];
                    if (!fileData) return;

                    let appToOpenId = null;
                    if (fileData.type.startsWith('text')) appToOpenId = 'notes';
                    else if (fileData.type.startsWith('video')) appToOpenId = 'video';
                    else if (fileData.type.startsWith('audio')) appToOpenId = 'music';
                    else if (fileData.type.startsWith('image')) appToOpenId = 'imageviewer';
                    else if (fileData.type === 'application/pdf') appToOpenId = 'pdf';

                    if (appToOpenId) {
                        const app = apps.find(a => a.id === appToOpenId);
                        const payload = { ...fileData, filename };
                        openWindow(app, payload);
                    } else {
                        alert(`No application available to open files of type: ${fileData.type}`);
                    }
                }
            });

            uploadBtn.onclick = () => uploadInput.click();
            uploadInput.onchange = () => {
                const files = getFiles();
                for (const file of uploadInput.files) {
                    if (files[file.name]) {
                        alert(`File "${file.name}" already exists. Please rename and upload again.`);
                        continue;
                    }

                    if (file.type.startsWith('text')) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            files[file.name] = { type: file.type, content: ev.target.result, size: file.size };
                            saveFiles(files);
                            render();
                        };
                        reader.readAsText(file);
                    } else {
                        files[file.name] = { type: file.type, url: URL.createObjectURL(file), size: file.size };
                    }
                }
                saveFiles(files);
                render();
                uploadInput.value = '';
            };

            newFileBtn.addEventListener('click', () => {
                const name = prompt('Enter filename (e.g., notes.txt):');
                if (name && name.trim()) {
                    const files = getFiles();
                    if (files[name] !== undefined) {
                        alert('File already exists!');
                        return;
                    }
                    files[name] = { type: 'text/plain', content: '' };
                    saveFiles(files);
                    render();
                }
            });

            deleteFileBtn.addEventListener('click', () => {
                if (selectedFile && confirm(`Are you sure you want to delete ${selectedFile}?`)) {
                    const files = getFiles();
                    const fileData = files[selectedFile];
                    if (fileData && fileData.url && fileData.url.startsWith('blob:')) {
                        URL.revokeObjectURL(fileData.url);
                    }
                    delete files[selectedFile];
                    saveFiles(files);
                    previewTitle.innerText = 'Select a file';
                    previewContent.innerHTML = '';
                    deleteFileBtn.style.display = 'none';
                    render();
                }
            });

            render();
        }

        function loadBrowser(container) {
            container.innerHTML = `
                <div class="browser-container">
                    <div class="browser-toolbar">
                        <button class="app-btn" id="browser-back">‚¨Ö</button>
                        <button class="app-btn" id="browser-refresh">‚Üª</button>
                        <input type="text" id="browser-url" class="browser-address" placeholder="https://...">
                        <button class="app-btn" id="browser-go">Go</button>
                    </div>
                    <div class="browser-bookmarks">
                        <button class="app-btn" id="bm-wiki">Wikipedia</button>
                    </div>
                    <iframe id="browser-frame" class="browser-frame" src="https://www.wikipedia.org"></iframe>
                </div>
            `;
            
            const frame = container.querySelector('#browser-frame');
            const urlInput = container.querySelector('#browser-url');
            
            const navigateTo = (url) => {
                if (!url.startsWith('http')) url = 'https://' + url;
                frame.src = url;
                urlInput.value = url;
            };

            container.querySelector('#browser-go').onclick = () => navigateTo(urlInput.value);
            container.querySelector('#browser-refresh').onclick = () => { try { frame.contentWindow.location.reload(); } catch(e) { frame.src = frame.src; } };
            container.querySelector('#browser-back').onclick = () => { try { frame.contentWindow.history.back(); } catch(e) { console.log('Cross-origin history blocked'); } };
            
            container.querySelector('#bm-wiki').onclick = () => navigateTo('https://www.wikipedia.org');

            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') navigateTo(urlInput.value);
            });
        }

        function loadMaps(container) {
            container.innerHTML = `
                <div class="maps-container">
                    <iframe class="maps-frame" src="https://www.openstreetmap.org/export/embed.html"></iframe>
                </div>
            `;
        }

        function loadTerminal(container, appId, win) {
            // Remove default padding
            container.style.padding = '0';
            container.innerHTML = `
                <div class="terminal-container" onclick="document.getElementById('term-input').focus()">
                    <div class="terminal-output" id="term-output">D4rsh OS Terminal [Version 1.0.0]\n(c) D4rsh Corp. All rights reserved.\n\nType 'help' to see available commands.\n</div>
                    <div class="terminal-input-line">
                        <span class="terminal-prompt">root@d4rsh:~$</span>
                        <input type="text" id="term-input" class="terminal-input" autocomplete="off" spellcheck="false">
                    </div>
                </div>
            `;
            const output = container.querySelector('#term-output');
            const input = container.querySelector('#term-input');
            const termContainer = container.querySelector('.terminal-container');
            const inputLine = container.querySelector('.terminal-input-line');
            let matrixInterval = null;

            if (!appTimers[appId]) appTimers[appId] = [];

            // Generic cleanup function attached to the window element
            if (win) {
                win.stopAppActivity = () => {
                    stopCMatrix();
                };
            }

            const stopCMatrix = () => {
                if (matrixInterval) {
                    clearInterval(matrixInterval);
                    const index = appTimers[appId].indexOf(matrixInterval);
                    if (index > -1) appTimers[appId].splice(index, 1);
                    matrixInterval = null;

                    const canvas = termContainer.querySelector('#matrix-canvas');
                    if (canvas) canvas.remove();
                    
                    output.style.display = 'block';
                    inputLine.style.display = 'flex';
                    document.removeEventListener('keydown', stopCMatrixOnKey);
                    input.focus();
                }
            };

            const stopCMatrixOnKey = (e) => {
                stopCMatrix();
            };

            const runCMatrix = () => {
                output.style.display = 'none';
                inputLine.style.display = 'none';

                const canvas = document.createElement('canvas');
                canvas.id = 'matrix-canvas';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                termContainer.prepend(canvas);

                const ctx = canvas.getContext('2d');
                canvas.width = termContainer.clientWidth;
                canvas.height = termContainer.clientHeight;

                const letters = 'Êó•ÔæäÔæêÔæãÔΩ∞ÔΩ≥ÔΩºÔæÖÔæìÔæÜÔΩªÔæúÔæÇÔΩµÔæòÔΩ±ÔæéÔæÉÔæèÔΩπÔæíÔΩ¥ÔΩ∂ÔΩ∑ÔæëÔæïÔæóÔΩæÔæàÔΩΩÔæÄÔæáÔæç0123456789';
                const fontSize = 16;
                const columns = canvas.width / fontSize;
                const drops = [];
                for (let x = 0; x < columns; x++) drops[x] = 1;

                matrixInterval = setInterval(() => {
                    ctx.fillStyle = 'rgba(30, 30, 30, 0.05)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.fillStyle = '#0f0';
                    ctx.font = fontSize + 'px monospace';

                    for (let i = 0; i < drops.length; i++) {
                        const text = letters.charAt(Math.floor(Math.random() * letters.length));
                        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                            drops[i] = 0;
                        }
                        drops[i]++;
                    }
                }, 33);
                appTimers[appId].push(matrixInterval);
                document.addEventListener('keydown', stopCMatrixOnKey, { once: true });
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const cmdLine = input.value;
                    const args = cmdLine.trim().split(' ');
                    const command = args[0].toLowerCase();
                    output.innerHTML += `<div><span class="terminal-prompt">root@d4rsh:~$</span> ${cmdLine}</div>`;
                    let response = '';
                    switch(command) {
                        case 'help':
                            response = "Commands: help, clear, echo, date, whoami, sudo, rm, exit, reboot, cmatrix";
                            break;
                        case 'cmatrix':
                            runCMatrix();
                            input.value = '';
                            output.scrollTop = output.scrollHeight;
                            return;
                        case 'clear':
                            output.innerHTML = '';
                            input.value = '';
                            return;
                        case 'echo':
                            response = args.slice(1).join(' ');
                            break;
                        case 'date':
                            response = new Date().toString();
                            break;
                        case 'whoami':
                            response = "You are a sentient being staring at a screen. Or just 'root'.";
                            break;
                        case 'sudo':
                            response = "With great power comes great responsibility. You have neither.";
                            break;
                        case 'rm':
                            if (args[1] === '-rf' && args[2] === '/') {
                                response = "I'm sorry Dave, I'm afraid I can't do that.";
                            } else {
                                response = "Deleting... just kidding. I can't delete files.";
                            }
                            break;
                        case 'exit':
                            closeWindow(container.closest('.window').id);
                            return;
                        case 'reboot':
                            response = "System is going down for reboot NOW! ...";
                            setTimeout(() => location.reload(), 2000);
                            break;
                        case '':
                            break;
                        default:
                            response = `Command '${command}' not found. Did you mean 'give_up'?`;
                    }
                    if(response) output.innerHTML += `<div style="color:#ccc">${response}</div>`;
                    input.value = '';
                    output.scrollTop = output.scrollHeight;
                }
            });
            // Auto focus
            setTimeout(() => input.focus(), 10);
        }

        function loadCalculator(container) {
            container.innerHTML = `
                <div class="calculator-container">
                    <input type="text" id="calc-display" readonly>
                    <div class="calculator-grid">
                        <button class="calc-btn clear">C</button>
                        <button class="calc-btn op">/</button>
                        <button class="calc-btn op">*</button>
                        <button class="calc-btn op">-</button>
                        <button class="calc-btn">7</button>
                        <button class="calc-btn">8</button>
                        <button class="calc-btn">9</button>
                        <button class="calc-btn op plus">+</button>
                        <button class="calc-btn">4</button>
                        <button class="calc-btn">5</button>
                        <button class="calc-btn">6</button>
                        <button class="calc-btn">1</button>
                        <button class="calc-btn">2</button>
                        <button class="calc-btn">3</button>
                        <button class="calc-btn equals">=</button>
                        <button class="calc-btn zero">0</button>
                        <button class="calc-btn">.</button>
                    </div>
                </div>
            `;

            const display = container.querySelector('#calc-display');
            const grid = container.querySelector('.calculator-grid');

            grid.addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON') return;
                const value = e.target.innerText;

                if (value === 'C') {
                    display.value = '';
                } else if (value === '=') {
                    try {
                        if (/[^0-9+\-*/.()]/.test(display.value)) {
                            display.value = 'Error';
                            return;
                        }
                        display.value = eval(display.value) || '';
                    } catch {
                        display.value = 'Error';
                    }
                } else {
                    if (display.value === 'Error') display.value = '';
                    display.value += value;
                }
            });
        }

        function loadPaint(container, win) {
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; height:100%;">
                    <div class="paint-toolbar">
                        <input type="color" id="paint-color" value="#e94560" title="Color">
                        <div id="paint-palette" class="paint-palette"></div>
                        <input type="range" id="paint-size" min="1" max="50" value="5" title="Brush Size">
                        <button class="app-btn" id="tool-brush" style="background:#fff; color:#000">Brush</button>
                        <button class="app-btn" id="tool-eraser">Eraser</button>
                        <button class="app-btn" id="tool-rect">Rect</button>
                        <button class="app-btn" id="tool-circle">Circle</button>
                        <button class="app-btn" onclick="clearCanvas()">Clear</button>
                        <button class="app-btn" onclick="saveCanvas()">Save</button>
                    </div>
                    <canvas id="paint-canvas" style="flex:1; background:#fff; cursor:crosshair; width:100%; touch-action:none;"></canvas>
                </div>
            `;

            const canvas = container.querySelector('#paint-canvas');
            const ctx = canvas.getContext('2d');
            const colorPicker = container.querySelector('#paint-color');
            const sizePicker = container.querySelector('#paint-size');
            const paletteContainer = container.querySelector('#paint-palette');
            
            let currentTool = 'brush';
            const tools = ['brush', 'eraser', 'rect', 'circle'];
            
            const setTool = (tool) => {
                currentTool = tool;
                tools.forEach(t => {
                    const btn = container.querySelector(`#tool-${t}`);
                    if (t === tool) {
                        btn.style.background = '#fff';
                        btn.style.color = '#000';
                    } else {
                        btn.style.background = '';
                        btn.style.color = '';
                    }
                });
            };

            tools.forEach(t => {
                container.querySelector(`#tool-${t}`).onclick = () => setTool(t);
            });
            
            colorPicker.oninput = () => { if(currentTool === 'eraser') setTool('brush'); };

            const colors = ['#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#e94560'];
            colors.forEach(c => {
                const swatch = document.createElement('div');
                swatch.className = 'paint-color-swatch';
                swatch.style.backgroundColor = c;
                swatch.onclick = () => { colorPicker.value = c; if(currentTool === 'eraser') setTool('brush'); };
                paletteContainer.appendChild(swatch);
            });

            // Set canvas resolution to match display size
            const updateCanvasSize = () => {
                const rect = canvas.getBoundingClientRect();
                if (canvas.width !== rect.width || canvas.height !== rect.height) {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    ctx.putImageData(imageData, 0, 0);
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                }
            };

            // Set canvas resolution to match display size
            setTimeout(() => {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }, 0);

            // Resize Observer
            const resizeObserver = new ResizeObserver(() => updateCanvasSize());
            resizeObserver.observe(container);

            let isDrawing = false;
            let startX = 0; let startY = 0;
            let snapshot;

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) * (canvas.width / rect.width),
                    y: (e.clientY - rect.top) * (canvas.height / rect.height)
                };
            };

            const start = (e) => {
                isDrawing = true;
                const pos = getPos(e);
                startX = pos.x;
                startY = pos.y;
                ctx.beginPath();
                ctx.lineWidth = sizePicker.value;
                ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : colorPicker.value;
                
                if (currentTool === 'rect' || currentTool === 'circle') {
                    snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                } else {
                    ctx.moveTo(startX, startY);
                }
            };
            const draw = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                
                if (currentTool === 'brush' || currentTool === 'eraser') {
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                } else if (currentTool === 'rect') {
                    ctx.putImageData(snapshot, 0, 0);
                    ctx.beginPath();
                    ctx.rect(startX, startY, pos.x - startX, pos.y - startY);
                    ctx.stroke();
                } else if (currentTool === 'circle') {
                    ctx.putImageData(snapshot, 0, 0);
                    ctx.beginPath();
                    const radius = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                }
            };
            const stop = () => isDrawing = false;

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            window.addEventListener('mouseup', stop);

            if (win) {
                win.stopAppActivity = () => {
                    window.removeEventListener('mouseup', stop);
                    resizeObserver.disconnect();
                };
            }

            window.clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
            window.saveCanvas = () => {
                const link = document.createElement('a');
                link.download = 'd4rsh-art.png';
                link.href = canvas.toDataURL();
                link.click();
            };
        }

        function loadNotes(container, data) {
            if (!data || !data.filename) {
                container.innerHTML = 'No file specified.';
                return;
            }
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; height:100%;">
                    <div style="padding-bottom:5px; margin-bottom:5px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">${data.filename}</h3>
                        <button class="app-btn" id="notes-save-btn">Save</button>
                    </div>
                    <textarea id="notes-content" style="flex:1; resize:none; user-select:text;">${data.content || ''}</textarea>
                </div>
            `;

            const saveBtn = container.querySelector('#notes-save-btn');
            const contentArea = container.querySelector('#notes-content');

            saveBtn.onclick = () => {
                const files = JSON.parse(localStorage.getItem('d4sh-fs') || '{}');
                if (files[data.filename]) {
                    files[data.filename].content = contentArea.value;
                    localStorage.setItem('d4sh-fs', JSON.stringify(files));
                    alert('File saved!');
                }
            };
        }

        function loadImageViewer(container, data = null) {
            if (!data || !data.url) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">No image file opened. Open an image from the File Explorer.</p>';
                return;
            }
            // Remove default padding for this app
            container.style.padding = '0';
            container.innerHTML = `
                <div class="image-viewer-container">
                    <img src="${data.url}">
                </div>
            `;
        }


        async function loadSysInfo(container) {
            container.innerHTML = '<h3>System Information</h3><ul id="sysinfo-list"></ul>';
            const list = container.querySelector('#sysinfo-list');
            const add = (k, v) => list.innerHTML += `<li><strong>${k}:</strong> ${v}</li>`;

            add('OS Platform', navigator.platform);
            add('User Agent', navigator.userAgent.replace(/^.*?\((.*?)\).*$/, '$1')); // Simplified UA
            add('Language', navigator.language);
            add('Screen Resolution', `${window.screen.width} x ${window.screen.height}`);
            add('Color Depth', `${window.screen.colorDepth}-bit`);
            add('Cores', navigator.hardwareConcurrency || 'Unknown');

            if (navigator.getBattery) {
                try {
                    const battery = await navigator.getBattery();
                    add('Battery Level', `${Math.round(battery.level * 100)}%`);
                    add('Charging', battery.charging ? 'Yes' : 'No');
                } catch (e) { add('Battery', 'Not Available'); }
            }
        }

        async function loadCamera(container, appId) {
            container.innerHTML = `
                <div class="media-container">
                    <video id="cam-feed" autoplay playsinline></video>
                    <div class="camera-controls">
                        <button class="app-btn" onclick="takePhoto()">üì∏ Take Photo</button>
                    </div>
                    <canvas id="cam-canvas" style="display:none;"></canvas>
                </div>
            `;
            
            const video = container.querySelector('#cam-feed');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                activeStreams[appId] = stream;
            } catch (e) {
                container.innerHTML = '<p style="padding:20px; text-align:center;">Camera access denied or unavailable.</p>';
            }

            window.takePhoto = () => {
                const canvas = container.querySelector('#cam-canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const link = document.createElement('a');
                link.download = `photo-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };
        }

        function loadVideoPlayer(container, data = null) {
            const videoSrc = data?.url || "https://www.w3schools.com/html/mov_bbb.mp4";
            container.innerHTML = `<div class="media-container"></div>`;
            const mediaContainer = container.querySelector('.media-container');
            
            const video = document.createElement('video');
            video.controls = true;
            video.style.width = '100%';
            video.style.height = '100%';
            video.src = videoSrc;
            mediaContainer.appendChild(video);
        }

        function loadMarkdown(container) {
            container.innerHTML = `
                <div class="markdown-container">
                    <textarea id="md-input" placeholder="# Hello World\n\nType markdown here..."></textarea>
                    <div id="md-preview"></div>
                </div>
            `;
            const input = container.querySelector('#md-input');
            const preview = container.querySelector('#md-preview');

            const parseMD = (text) => {
                return text
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                    .replace(/\*(.*)\*/gim, '<i>$1</i>')
                    .replace(/!\[(.*?)\]\((.*?)\)/gim, "<img alt='$1' src='$2' />")
                    .replace(/\[(.*?)\]\((.*?)\)/gim, "<a href='$2' target='_blank' style='color:cyan'>$1</a>")
                    .replace(/\n/gim, '<br />');
            };

            input.addEventListener('input', () => {
                preview.innerHTML = parseMD(input.value);
            });
        }

        function loadMusicPlayer(container, appId, data = null) {
            if (audioContexts[appId]) {
                audioContexts[appId].close();
                delete audioContexts[appId];
            }

            const audioSrc = data?.url || "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
            container.innerHTML = `
                <div class="media-container">
                    <canvas id="viz-${appId}" class="music-visualizer"></canvas>
                </div>
            `;
            const mediaContainer = container.querySelector('.media-container');

            const audio = document.createElement('audio');
            audio.id = `audio-${appId}`;
            audio.controls = true;
            audio.crossOrigin = 'anonymous';
            audio.style.width = '100%';
            audio.style.marginTop = 'auto';
            audio.src = audioSrc;
            mediaContainer.appendChild(audio);
            
            const canvas = container.querySelector(`#viz-${appId}`);
            const ctx = canvas.getContext('2d');

            // Initialize Web Audio API on play
            audio.onplay = () => {
                if (!audioContexts[appId]) {
                    const actx = new (window.AudioContext || window.webkitAudioContext)();
                    audioContexts[appId] = actx;
                    const src = actx.createMediaElementSource(audio);
                    const analyser = actx.createAnalyser();
                    
                    src.connect(analyser);
                    analyser.connect(actx.destination);
                    analyser.fftSize = 256;

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    const renderFrame = () => {
                        if (!document.getElementById(`win-${appId}`)) return;
                        if (audioContexts[appId] !== actx) return;
                        requestAnimationFrame(renderFrame);
                        analyser.getByteFrequencyData(dataArray);
                        
                        ctx.fillStyle = '#000';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        const barWidth = (canvas.width / bufferLength) * 2.5;
                        let barHeight;
                        let x = 0;

                        for (let i = 0; i < bufferLength; i++) {
                            barHeight = dataArray[i] / 2;
                            ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                            x += barWidth + 1;
                        }
                    };
                    renderFrame();
                }
                if (audioContexts[appId].state === 'suspended') audioContexts[appId].resume();
            };
        }

        function loadClock(container, appId) {
            container.innerHTML = `
                <div class="clock-container">
                    <div class="clock-tabs">
                        <button class="app-btn" data-tab="time">Clock</button>
                        <button class="app-btn" data-tab="stopwatch">Stopwatch</button>
                        <button class="app-btn" data-tab="timer">Timer</button>
                    </div>
                    
                    <div id="clock-section-time" class="clock-section">
                        <div class="clock-time" id="clock-display">00:00:00</div>
                        <div id="clock-date" style="font-size: 1.2em; color: #aaa;"></div>
                    </div>

                    <div id="clock-section-stopwatch" class="clock-section" style="display:none;">
                        <div class="clock-time" id="sw-display">00:00:00.00</div>
                        <button class="app-btn" id="sw-toggle">Start</button>
                        <button class="app-btn" id="sw-reset">Reset</button>
                    </div>

                    <div id="clock-section-timer" class="clock-section" style="display:none;">
                        <div class="clock-time" id="timer-display">00:00:00</div>
                        <input type="number" id="timer-input" placeholder="Minutes" style="width: 100px; text-align: center; margin-bottom: 10px;">
                        <br>
                        <button class="app-btn" id="timer-toggle">Start</button>
                        <button class="app-btn" id="timer-reset">Reset</button>
                    </div>
                </div>
            `;

            if(!appTimers[appId]) appTimers[appId] = [];

            // Tabs
            container.querySelectorAll('.clock-tabs button').forEach(btn => {
                btn.onclick = () => {
                    container.querySelectorAll('.clock-section').forEach(s => s.style.display = 'none');
                    container.querySelector(`#clock-section-${btn.dataset.tab}`).style.display = 'block';
                };
            });

            // Clock
            const updateClock = () => {
                const now = new Date();
                container.querySelector('#clock-display').innerText = now.toLocaleTimeString();
                container.querySelector('#clock-date').innerText = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };
            updateClock();
            appTimers[appId].push(setInterval(updateClock, 1000));

            // Stopwatch
            let swStart = 0, swElapsed = 0, swInterval = null;
            const swDisplay = container.querySelector('#sw-display');
            const swBtn = container.querySelector('#sw-toggle');
            
            swBtn.onclick = () => {
                if (swInterval) {
                    clearInterval(swInterval); swInterval = null; swBtn.innerText = 'Start';
                } else {
                    swStart = Date.now() - swElapsed;
                    swInterval = setInterval(() => {
                        swElapsed = Date.now() - swStart;
                        swDisplay.innerText = new Date(swElapsed).toISOString().slice(11, 22);
                    }, 10);
                    appTimers[appId].push(swInterval);
                    swBtn.innerText = 'Stop';
                }
            };
            container.querySelector('#sw-reset').onclick = () => {
                if(swInterval) clearInterval(swInterval);
                swInterval = null; swElapsed = 0; swDisplay.innerText = '00:00:00.00'; swBtn.innerText = 'Start';
            };

            // Timer
            let tmInterval = null, tmRemaining = 0;
            const tmDisplay = container.querySelector('#timer-display');
            const tmBtn = container.querySelector('#timer-toggle');
            const tmInput = container.querySelector('#timer-input');

            tmBtn.onclick = () => {
                if (tmInterval) {
                    clearInterval(tmInterval); tmInterval = null; tmBtn.innerText = 'Start';
                } else {
                    if (tmRemaining <= 0) tmRemaining = (parseInt(tmInput.value) || 0) * 60;
                    if (tmRemaining <= 0) return;
                    
                    tmBtn.innerText = 'Stop';
                    tmInterval = setInterval(() => {
                        tmRemaining--;
                        const h = Math.floor(tmRemaining / 3600).toString().padStart(2,'0');
                        const m = Math.floor((tmRemaining % 3600) / 60).toString().padStart(2,'0');
                        const s = (tmRemaining % 60).toString().padStart(2,'0');
                        tmDisplay.innerText = `${h}:${m}:${s}`;
                        
                        if (tmRemaining <= 0) {
                            clearInterval(tmInterval); tmInterval = null; tmBtn.innerText = 'Start';
                            alert('Timer Finished!');
                        }
                    }, 1000);
                    appTimers[appId].push(tmInterval);
                }
            };
            container.querySelector('#timer-reset').onclick = () => {
                if(tmInterval) clearInterval(tmInterval);
                tmInterval = null; tmRemaining = 0; tmDisplay.innerText = '00:00:00'; tmBtn.innerText = 'Start';
            };
        }

        function loadCalendar(container) {
            container.innerHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="app-btn" id="cal-prev">&lt;</button>
                        <h3 id="cal-month-year" style="margin:0"></h3>
                        <button class="app-btn" id="cal-next">&gt;</button>
                    </div>
                    <div class="calendar-grid" id="cal-grid"></div>
                </div>
            `;

            let date = new Date();
            let currMonth = date.getMonth();
            let currYear = date.getFullYear();

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const header = container.querySelector('#cal-month-year');
            const grid = container.querySelector('#cal-grid');

            const render = () => {
                header.innerText = `${monthNames[currMonth]} ${currYear}`;
                grid.innerHTML = '';

                // Day names
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    grid.innerHTML += `<div class="calendar-day-name">${day}</div>`;
                });

                const firstDay = new Date(currYear, currMonth, 1).getDay();
                const daysInMonth = new Date(currYear, currMonth + 1, 0).getDate();
                const today = new Date();

                // Empty slots
                for (let i = 0; i < firstDay; i++) {
                    grid.innerHTML += `<div class="calendar-date empty"></div>`;
                }

                // Days
                for (let i = 1; i <= daysInMonth; i++) {
                    const isToday = i === today.getDate() && currMonth === today.getMonth() && currYear === today.getFullYear();
                    grid.innerHTML += `<div class="calendar-date ${isToday ? 'today' : ''}">${i}</div>`;
                }
            };

            container.querySelector('#cal-prev').onclick = () => {
                currMonth--;
                if (currMonth < 0) { currMonth = 11; currYear--; }
                render();
            };

            container.querySelector('#cal-next').onclick = () => {
                currMonth++;
                if (currMonth > 11) { currMonth = 0; currYear++; }
                render();
            };

            render();
        }

        function loadPDFViewer(container, data = null) {
            container.innerHTML = `
                <div class="pdf-container">
                    <div style="padding: 5px; background: #e0e0e0; border-bottom: 1px solid #ccc;">
                        <input type="file" id="pdf-upload" accept="application/pdf" style="width: auto;">
                    </div>
                </div>
            `;
            const pdfContainer = container.querySelector('.pdf-container');
            
            const frame = document.createElement('iframe');
            frame.id = 'pdf-frame';
            frame.src = data?.url || '';
            pdfContainer.appendChild(frame);

            const input = container.querySelector('#pdf-upload');
            input.onchange = () => {
                if (input.files && input.files[0]) {
                    const url = URL.createObjectURL(input.files[0]);
                    frame.src = url;
                }
            };
        }

        // --- SETTINGS & GOOGLE DRIVE SYNC ---
        
        let CLIENT_ID; 
        let API_KEY;
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const BACKUP_FILENAME = 'd4rsh_os_data.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;

        // Callback for script load
        window.gapiLoaded = () => gapi.load('client', () => { gapiInited = true; checkAuth(); });
        window.gisLoaded = () => { gisInited = true; checkAuth(); };

        // Fetch config from Vercel API
        fetch('/api/env').then(res => res.json()).then(config => {
            CLIENT_ID = config.CLIENT_ID;
            API_KEY = config.API_KEY;
            checkAuth();
        }).catch(e => console.log('Running locally or config missing'));

        function checkAuth() {
            const btn = document.getElementById('auth-btn');
            if(btn && gapiInited && gisInited && CLIENT_ID && API_KEY) btn.disabled = false;
        }

        function loadSettings(container) {
            const configMsg = (CLIENT_ID && API_KEY) ? '' : '<p style="color:#ff5555; font-size:12px;">‚ö†Ô∏è Config loading or missing. Check Vercel Env Vars.</p>';
            const currentTheme = localStorage.getItem('d4sh-theme') || 'dark';
            const currentWallpaper = localStorage.getItem('d4sh-wallpaper') || '';
            
            container.innerHTML = `
                <div class="settings-container">
                    <h3>Personalization</h3>
                    <div class="settings-group">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                            <span>Dark Mode</span>
                            <input type="checkbox" ${currentTheme === 'dark' ? 'checked' : ''} onchange="applyTheme(this.checked ? 'dark' : 'light')">
                        </div>
                        <label>Wallpaper URL:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="wallpaper-input" value="${currentWallpaper}" placeholder="https://example.com/image.jpg">
                            <button class="app-btn" onclick="saveWallpaper(document.getElementById('wallpaper-input').value)">Set</button>
                        </div>
                        <button class="app-btn" style="margin-top:5px; background:#555;" onclick="resetWallpaper()">Reset Default</button>
                    </div>

                    <h3>Cloud Sync (Google Drive)</h3>
                    <div class="settings-group">
                        ${configMsg}
                        <p style="font-size:14px; color:#ccc;">Sign in to sync data to <b>your personal Google Drive</b>.</p>
                        <button class="app-btn" id="auth-btn" disabled onclick="handleAuth()">Sign In with Google</button>
                        <p id="auth-status" style="font-size:12px; color:#aaa;">Waiting for scripts...</p>
                    </div>
                    <div class="settings-group">
                        <button class="app-btn" id="sync-btn" disabled onclick="syncToDrive()">‚¨Ü Sync Local to Cloud</button>
                        <button class="app-btn" id="restore-btn" disabled onclick="restoreFromDrive()">‚¨á Restore Cloud to Local</button>
                        <div id="sync-progress-container" style="display:none; margin-top: 10px;">
                            <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div id="sync-progress-bar" style="width: 0%; height: 100%; background: var(--text-color); transition: width 0.2s;"></div>
                            </div>
                            <div id="sync-status-text" style="font-size: 12px; text-align: center; margin-top: 5px; color: #aaa;"></div>
                        </div>
                    </div>

                    <h3>About</h3>
                    <div class="settings-group">
                        <p id="matrix-credits" class="matrix-text">Made by Darshan</p>
                    </div>
                </div>
            `;
            checkAuth();

            const credits = container.querySelector('#matrix-credits');
            const originalText = "Made by Darshan";
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890@#$%^&*";
            let matrixInterval = null;

            const runMatrix = () => {
                let iteration = 0;
                clearInterval(matrixInterval);
                
                matrixInterval = setInterval(() => {
                    credits.innerText = originalText.split("").map((letter, index) => {
                        if(index < iteration) return originalText[index];
                        return letters[Math.floor(Math.random() * letters.length)];
                    }).join("");
                    
                    if(iteration >= originalText.length) clearInterval(matrixInterval);
                    iteration += 1 / 3;
                }, 30);
            };

            credits.onmouseover = runMatrix;
            runMatrix();
        }

        window.saveWallpaper = (url) => {
            if (!url) return;
            const bgStyle = url.startsWith('http') || url.startsWith('data') ? `url(${url}) no-repeat center center / cover` : url;
            document.body.style.background = bgStyle;
            localStorage.setItem('d4sh-wallpaper', url);
        };

        window.resetWallpaper = () => {
             document.body.style.background = '';
             localStorage.removeItem('d4sh-wallpaper');
             document.getElementById('wallpaper-input').value = '';
        };

        async function handleAuth() {
            if(!CLIENT_ID || !API_KEY) { alert('Configuration missing. Please check your Vercel Environment Variables.'); return; }

            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error) throw resp;
                    document.getElementById('auth-status').innerText = 'Signed In. Searching for backup...';
                    await findBackup();
                },
            });

            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        async function findBackup() {
            try {
                const res = await gapi.client.drive.files.list({
                    q: `name = '${BACKUP_FILENAME}' and trashed = false`,
                    fields: 'files(id, name)',
                });
                const files = res.result.files;
                if (files && files.length > 0) {
                    driveFileId = files[0].id;
                    document.getElementById('auth-status').innerText = 'Connected. Backup found.';
                    document.getElementById('restore-btn').disabled = false;
                } else {
                    document.getElementById('auth-status').innerText = 'Connected. No backup found (will create new).';
                }
                document.getElementById('sync-btn').disabled = false;
            } catch (err) {
                document.getElementById('auth-status').innerText = 'Error: ' + err.message;
            }
        }

        async function syncToDrive() {
            const progressContainer = document.getElementById('sync-progress-container');
            const progressBar = document.getElementById('sync-progress-bar');
            const statusText = document.getElementById('sync-status-text');
            
            if(progressContainer) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                statusText.innerText = 'Preparing files...';
            }

            const backupData = {};
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) keys.push(localStorage.key(i));

            for (const key of keys) {
                if (key.startsWith('d4sh-')) {
                    if (key === 'd4sh-fs') {
                        const allFiles = JSON.parse(localStorage.getItem('d4sh-fs') || '{}');
                        const persistentFs = {};
                        await Promise.all(Object.keys(allFiles).map(async (filename) => {
                            const file = allFiles[filename];
                            if (file.url && file.url.startsWith('blob:')) {
                                try {
                                    const blob = await fetch(file.url).then(r => r.blob());
                                    const dataUrl = await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(blob); });
                                    persistentFs[filename] = { ...file, url: dataUrl };
                                } catch (e) { console.error('Backup failed for', filename); }
                            } else {
                                persistentFs[filename] = file;
                            }
                        }));
                        backupData[key] = JSON.stringify(persistentFs);
                    } else {
                        backupData[key] = localStorage.getItem(key);
                    }
                }
                if(progressBar) progressBar.style.width = '30%'; // Preparation done
            }
            
            const file = new Blob([JSON.stringify(backupData)], {type: 'application/json'});
            const metadata = { name: BACKUP_FILENAME, mimeType: 'application/json' };
            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            const url = driveFileId 
                ? `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`
                : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            
            const method = driveFileId ? 'PATCH' : 'POST';

            const xhr = new XMLHttpRequest();
            xhr.open(method, url);
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable && progressBar) {
                    const percentComplete = (e.loaded / e.total) * 70 + 30;
                    progressBar.style.width = percentComplete + '%';
                    statusText.innerText = `Uploading: ${Math.round((e.loaded / e.total) * 100)}%`;
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const val = JSON.parse(xhr.responseText);
                    if(val.id) driveFileId = val.id;
                    if(progressBar) progressBar.style.width = '100%';
                    if(statusText) statusText.innerText = 'Sync Complete!';
                    setTimeout(() => {
                        if(progressContainer) progressContainer.style.display = 'none';
                    }, 2000);
                    alert('Sync Successful!');
                } else {
                    if(statusText) statusText.innerText = 'Upload Failed';
                    alert('Sync Failed: ' + xhr.statusText);
                }
            };

            xhr.onerror = () => {
                if(statusText) statusText.innerText = 'Network Error';
                alert('Sync Failed: Network Error');
            };

            xhr.send(form);
        }

        async function restoreFromDrive() {
            const res = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });

            const currentFiles = JSON.parse(localStorage.getItem('d4sh-fs') || '{}');
            for (const filename in currentFiles) {
                if (currentFiles[filename].url && currentFiles[filename].url.startsWith('blob:')) {
                    URL.revokeObjectURL(currentFiles[filename].url);
                }
            }

            const data = res.result; // gapi auto-parses JSON
            Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
            alert('Restored! Reloading...');
            location.reload();
        }

        // --- GAMES ---

        function loadSnake(container, appId) {
            container.innerHTML = '<div class="game-container"><canvas id="snake-canvas" width="300" height="300"></canvas><p style="text-align:center">Arrows to move</p></div>';
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');
            
            let snake = [{x: 10, y: 10}];
            let food = {x: 15, y: 15};
            let dx = 0, dy = 0;
            let gridSize = 15;
            let tileCount = 20;

            function gameLoop() {
                snake[0].x += dx;
                snake[0].y += dy;

                // Wall collision
                if (snake[0].x < 0) snake[0].x = tileCount - 1;
                if (snake[0].x >= tileCount) snake[0].x = 0;
                if (snake[0].y < 0) snake[0].y = tileCount - 1;
                if (snake[0].y >= tileCount) snake[0].y = 0;

                // Background
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Food
                ctx.fillStyle = 'red';
                ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);

                // Snake
                ctx.fillStyle = 'lime';
                for (let i = 0; i < snake.length; i++) {
                    ctx.fillRect(snake[i].x * gridSize, snake[i].y * gridSize, gridSize - 2, gridSize - 2);
                    if (i > 0 && snake[i].x === snake[0].x && snake[i].y === snake[0].y) {
                        // Tail collision reset
                        snake = [{x: 10, y: 10}];
                        dx = 0; dy = 0;
                    }
                }

                // Move body
                for (let i = snake.length - 1; i > 0; i--) {
                    snake[i] = {...snake[i-1]};
                }

                // Eat food
                if (snake[0].x === food.x && snake[0].y === food.y) {
                    snake.push({});
                    food = {
                        x: Math.floor(Math.random() * tileCount),
                        y: Math.floor(Math.random() * tileCount)
                    };
                }
            }

            document.addEventListener('keydown', e => {
                // Only control if window is focused (simple check: is it the top z-index?)
                // For simplicity in this demo, we just check if the key is pressed.
                // In a real OS, we'd check document.activeElement or similar.
                if(container.closest('.window').style.zIndex != zIndexCounter) return;

                switch(e.key) {
                    case 'ArrowLeft': if(dx!==1) { dx=-1; dy=0; } break;
                    case 'ArrowRight': if(dx!==-1) { dx=1; dy=0; } break;
                    case 'ArrowUp': if(dy!==1) { dx=0; dy=-1; } break;
                    case 'ArrowDown': if(dy!==-1) { dx=0; dy=1; } break;
                }
            });

            gameIntervals[appId] = setInterval(gameLoop, 100);
        }

        function loadDino(container, appId) {
            container.innerHTML = '<div class="game-container"><canvas id="dino-canvas" width="300" height="150"></canvas><p style="text-align:center">Space to Jump</p></div>';
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            let dino = { x: 20, y: 120, w: 20, h: 20, dy: 0, jump: false };
            let obstacles = [];
            let frame = 0;
            let score = 0;
            let gameOver = false;

            function reset() {
                dino.y = 120; dino.dy = 0; obstacles = []; frame = 0; score = 0; gameOver = false;
            }

            function loop() {
                if (gameOver) {
                    ctx.fillStyle = 'white';
                    ctx.fillText("Game Over. Space to restart", 80, 75);
                    return;
                }

                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Ground
                ctx.strokeStyle = 'white';
                ctx.beginPath(); ctx.moveTo(0, 140); ctx.lineTo(300, 140); ctx.stroke();

                // Dino Physics
                if (dino.jump) {
                    dino.dy = -5;
                    dino.jump = false;
                }
                dino.y += dino.dy;
                dino.dy += 0.3; // Gravity
                if (dino.y > 120) { dino.y = 120; dino.dy = 0; }

                // Draw Dino
                ctx.fillStyle = 'white';
                ctx.fillRect(dino.x, dino.y, dino.w, dino.h);

                // Obstacles
                if (frame % 100 === 0) {
                    obstacles.push({ x: 300, w: 15, h: 20 });
                }

                obstacles.forEach((obs, i) => {
                    obs.x -= 3;
                    ctx.fillStyle = 'red';
                    ctx.fillRect(obs.x, 120, obs.w, obs.h);

                    // Collision
                    if (dino.x < obs.x + obs.w && dino.x + dino.w > obs.x &&
                        dino.y < 120 + obs.h && dino.y + dino.h > 120) {
                        gameOver = true;
                    }

                    if (obs.x + obs.w < 0) obstacles.splice(i, 1);
                });

                ctx.fillStyle = 'white';
                ctx.fillText(`Score: ${frame}`, 240, 20);
                frame++;
            }

            document.addEventListener('keydown', e => {
                if(container.closest('.window').style.zIndex != zIndexCounter) return;
                if (e.code === 'Space') {
                    if (gameOver) reset();
                    else if (dino.y === 120) dino.jump = true;
                }
            });

            gameIntervals[appId] = setInterval(loop, 20);
        }

        function loadFlappy(container, appId) {
            container.innerHTML = '<div class="game-container"><canvas id="flappy-canvas" width="300" height="400"></canvas><p style="text-align:center">Space to Flap</p></div>';
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            let bird = { x: 50, y: 150, dy: 0, r: 10 };
            let pipes = [];
            let frame = 0;
            let gameOver = false;

            function reset() {
                bird.y = 150; bird.dy = 0; pipes = []; frame = 0; gameOver = false;
            }

            function loop() {
                if (gameOver) {
                    ctx.fillStyle = 'white';
                    ctx.fillText("Game Over. Space to restart", 80, 200);
                    return;
                }

                ctx.fillStyle = '#333';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Bird
                bird.dy += 0.2;
                bird.y += bird.dy;
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2);
                ctx.fill();

                // Pipes
                if (frame % 120 === 0) {
                    let gap = 100;
                    let topH = Math.random() * (canvas.height - gap - 50) + 20;
                    pipes.push({ x: 300, top: topH, gap: gap });
                }

                pipes.forEach((p, i) => {
                    p.x -= 2;
                    ctx.fillStyle = 'green';
                    // Top pipe
                    ctx.fillRect(p.x, 0, 40, p.top);
                    // Bottom pipe
                    ctx.fillRect(p.x, p.top + p.gap, 40, canvas.height - (p.top + p.gap));

                    // Collision
                    if (bird.x + bird.r > p.x && bird.x - bird.r < p.x + 40) {
                        if (bird.y - bird.r < p.top || bird.y + bird.r > p.top + p.gap) {
                            gameOver = true;
                        }
                    }
                    if (p.x + 40 < 0) pipes.splice(i, 1);
                });

                // Floor/Ceiling collision
                if (bird.y + bird.r > canvas.height || bird.y - bird.r < 0) gameOver = true;

                frame++;
            }

            document.addEventListener('keydown', e => {
                if(container.closest('.window').style.zIndex != zIndexCounter) return;
                if (e.code === 'Space') {
                    if (gameOver) reset();
                    else bird.dy = -4;
                }
            });

            gameIntervals[appId] = setInterval(loop, 20);
        }

        // Start
        init();
    </script>
</body>
</html>
